name: Auto create CODEOWNERS on new repos

on:
  schedule:
    # Run each day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  add-codeowners:
    runs-on: ubuntu-latest

    steps:
      - name: Scan repos and add CODEOWNERS where missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ORG_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const codeownersContent = "# Code ownership rules\n.github/ @HausAnalytics/squad-infra-eng\n";
            const path = "CODEOWNERS";

            // Get all repositories in the organization
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: owner,
              type: 'all',
              per_page: 100
            });

            core.info(`Found ${repos.length} repositories to check`);

            for (const repo of repos) {
              try {
                // Skip archived repos
                if (repo.archived) {
                  core.info(`Skipping archived repo: ${repo.name}`);
                  continue;
                }
                
                // Skip repos older than 24 hours
                const createdAt = new Date(repo.created_at);
                const now = new Date();
                const hoursSinceCreation = (now - createdAt) / (1000 * 60 * 60);
                
                if (hoursSinceCreation > 24) {
                  core.info(`Skipping repo older than 24 hours: ${repo.name}`);
                  continue;
                }
                
                // Check if CODEOWNERS already exists
                try {
                  await github.rest.repos.getContent({
                    owner: owner,
                    repo: repo.name,
                    path: path
                  });
                  core.info(`CODEOWNERS already exists in ${repo.name}`);
                  continue;
                } catch (error) {
                  if (error.status !== 404) throw error;
                  // File doesn't exist, continue to create it
                }
                
                // Check if repo has any commits (has a default branch)
                if (!repo.default_branch) {
                  core.info(`Skipping empty repo: ${repo.name}`);
                  continue;
                }
                
                // Create CODEOWNERS file
                await github.rest.repos.createOrUpdateFileContents({
                  owner: owner,
                  repo: repo.name,
                  path: path,
                  message: "Add default CODEOWNERS file",
                  content: Buffer.from(codeownersContent).toString("base64"),
                  branch: repo.default_branch
                });
                
                core.info(`CODEOWNERS added to ${repo.name}`);
                
                // Add squad-infra-eng team with write permissions
                try {
                  await github.rest.teams.addOrUpdateRepoPermissionsInOrg({
                    org: owner,
                    team_slug: 'squad-infra-eng',
                    owner: owner,
                    repo: repo.name,
                    permission: 'push'  // push = write access
                  });
                  core.info(`Added squad-infra-eng team with write permissions to ${repo.name}`);
                } catch (teamError) {
                  core.warning(`Failed to add team to ${repo.name}: ${teamError.message}`);
                }
                
              } catch (error) {
                core.warning(`Failed to process ${repo.name}: ${error.message}`);
              }
            }

            core.info('Finished processing all repositories');
