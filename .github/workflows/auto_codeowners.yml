name: Auto create CODEOWNERS on new repos

on:
#  schedule:
    # Run every 4 hours
#    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  add-codeowners:
    runs-on: ubuntu-latest

    steps:
      - name: Scan repos and add CODEOWNERS where missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_ORG_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const codeownersContent = "# Code ownership rules\n.github/ @HausAnalytics/squad-infra-eng\n";
            const path = ".github/CODEOWNERS";

            // Get all repositories in the organization
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: owner,
              type: 'all',
              per_page: 100
            });

            core.info(`Found ${repos.length} repositories to check`);

            for (const repo of repos) {
              try {
                // Skip archived repos
                if (repo.archived) {
                  core.info(`Skipping archived repo: ${repo.name}`);
                  continue;
                }
                
                // Skip repos older than 24 hours
                const createdAt = new Date(repo.created_at);
                const now = new Date();
                const hoursSinceCreation = (now - createdAt) / (1000 * 60 * 60);
                
                if (hoursSinceCreation > 24) {
                  core.info(`Skipping repo older than 24 hours: ${repo.name}`);
                  continue;
                }
                
                // Check if repo has any commits (has a default branch)
                if (!repo.default_branch) {
                  core.info(`Skipping empty repo: ${repo.name}`);
                  continue;
                }
                
                // Check if CODEOWNERS already exists and if it has the infra-eng rule
                let existingFile = null;
                let needsUpdate = false;
                
                try {
                  const fileData = await github.rest.repos.getContent({
                    owner: owner,
                    repo: repo.name,
                    path: path
                  });
                  
                  existingFile = fileData.data;
                  const existingContent = Buffer.from(existingFile.content, 'base64').toString('utf-8');
                  
                  // Check if the infra-eng rule already exists
                  if (existingContent.includes('.github/ @HausAnalytics/squad-infra-eng')) {
                    core.info(`CODEOWNERS already has infra-eng rule in ${repo.name}`);
                    continue;
                  } else {
                    // File exists but doesn't have the rule, we need to add it
                    needsUpdate = true;
                    core.info(`CODEOWNERS exists but missing infra-eng rule in ${repo.name}, adding it`);
                  }
                } catch (error) {
                  if (error.status !== 404) throw error;
                  // File doesn't exist, we'll create it
                  core.info(`CODEOWNERS doesn't exist in ${repo.name}, creating it`);
                }
                
                // Prepare the content
                let finalContent;
                if (needsUpdate && existingFile) {
                  // Prepend our rule to the existing content
                  const existingContent = Buffer.from(existingFile.content, 'base64').toString('utf-8');
                  finalContent = codeownersContent + existingContent;
                } else {
                  // New file
                  finalContent = codeownersContent;
                }
                
                // Create or update CODEOWNERS file
                await github.rest.repos.createOrUpdateFileContents({
                  owner: owner,
                  repo: repo.name,
                  path: path,
                  message: needsUpdate ? "Add infra-eng team to CODEOWNERS" : "Add default CODEOWNERS file",
                  content: Buffer.from(finalContent).toString("base64"),
                  branch: repo.default_branch,
                  ...(existingFile && { sha: existingFile.sha })
                });
                
                core.info(`CODEOWNERS updated in ${repo.name}`);
                
                // Add squad-infra-eng team with write permissions
                try {
                  await github.rest.teams.addOrUpdateRepoPermissionsInOrg({
                    org: owner,
                    team_slug: 'squad-infra-eng',
                    owner: owner,
                    repo: repo.name,
                    permission: 'push'  // push = write access
                  });
                  core.info(`Added squad-infra-eng team with write permissions to ${repo.name}`);
                } catch (teamError) {
                  core.warning(`Failed to add team to ${repo.name}: ${teamError.message}`);
                }
                
              } catch (error) {
                core.warning(`Failed to process ${repo.name}: ${error.message}`);
              }
            }

            core.info('Finished processing all repositories');
