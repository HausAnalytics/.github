name: "Organization Stale Issues and PRs Management"

on:
  schedule:
    # Run daily at 1:30 AM UTC (dry run only for scheduled runs)
    - cron: "30 1 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode - only log what would be done"
        required: false
        default: false
        type: boolean
      org_name:
        description: "Organization name to scan"
        required: false
        default: "HausAnalytics"
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  DAYS_BEFORE_STALE: 30
  DAYS_BEFORE_CLOSE: 5
  STALE_LABEL: "stale"
  EXEMPT_PR_LABEL: "do not close"
  STALE_ISSUE_MESSAGE: "This issue is stale because it has been open 30 days with no activity. Remove stale label or comment or this will be closed in 5 days."
  STALE_PR_MESSAGE: "This PR is stale because it has been open 30 days with no activity. Remove stale label or comment or this will be closed in 5 days."
  CLOSE_ISSUE_MESSAGE: "This issue was closed because it has been stalled for 5 days with no activity."
  CLOSE_PR_MESSAGE: "This PR was closed because it has been stalled for 5 days with no activity."

jobs:
  get-repositories:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.get-repos.outputs.repos }}
    steps:
      - name: Get non-archived repositories
        id: get-repos
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          set -e
          ORG="${{ inputs.org_name || 'HausAnalytics' }}"

          echo ""
          echo "========================================"
          echo "Fetching repositories..."
          echo "========================================"
          echo ""
          echo "Organization: $ORG"
          echo "Filter: non-archived repositories with issues enabled"
          echo ""

          # Verify token and API access
          echo "Verifying API access..."
          if ! gh api user --silent 2>&1; then
            echo "ERROR: Failed to authenticate with GitHub API"
            echo "Please ensure GH_ORG_TOKEN secret is set with appropriate permissions"
            exit 1
          fi
          echo "API access verified."
          echo ""

          # Get all non-archived repos with issues enabled using REST API
          echo "Querying repositories for organization: $ORG"
          echo ""

          # Use REST API - more reliable than GraphQL with pagination
          REPOS_RAW=$(gh api "orgs/$ORG/repos" --paginate --jq '.[] | select(.archived == false) | select(.has_issues == true) | .name')

          if [ -z "$REPOS_RAW" ]; then
            echo "WARNING: No repositories found. This could mean:"
            echo "  - The organization has no non-archived repositories with issues enabled"
            echo "  - The token lacks permission to view organization repositories"
            echo "  - The organization name is incorrect"
            REPOS="[]"
            REPO_COUNT=0
          else
            # Convert to JSON array
            REPOS=$(echo "$REPOS_RAW" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            REPO_COUNT=$(echo "$REPOS" | jq 'length')
          fi

          echo ""
          echo "Found $REPO_COUNT repositories:"
          echo ""

          # List each repository
          if [ -n "$REPOS_RAW" ]; then
            echo "$REPOS_RAW" | while read -r repo; do
              if [ -n "$repo" ]; then
                echo "  - $repo"
              fi
            done
          else
            echo "  (none)"
          fi

          echo ""
          echo "========================================"
          echo ""

          echo "repos=$REPOS" >> $GITHUB_OUTPUT

  process-stale:
    needs: get-repositories
    runs-on: ubuntu-latest
    if: ${{ needs.get-repositories.outputs.repos != '[]' && needs.get-repositories.outputs.repos != '' }}
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        repo: ${{ fromJson(needs.get-repositories.outputs.repos) }}
    steps:
      - name: Process stale issues and PRs for ${{ matrix.repo }}
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
          # Force dry run for scheduled runs, otherwise use input value
          DRY_RUN: ${{ github.event_name == 'schedule' && 'true' || inputs.dry_run || 'false' }}
        run: |
          ORG="${{ inputs.org_name || 'HausAnalytics' }}"
          REPO="${{ matrix.repo }}"
          FULL_REPO="$ORG/$REPO"

          # Initialize statistics counters
          ISSUES_FETCHED=0
          PRS_FETCHED=0
          ISSUES_MARKED_STALE=0
          PRS_MARKED_STALE=0
          ISSUES_CLOSED=0
          PRS_CLOSED=0
          OPERATIONS_PERFORMED=0
          API_CALLS=0

          echo ""
          echo "========================================"
          echo "Starting the stale action process..."
          echo "========================================"
          echo ""
          echo "Repository: $FULL_REPO"
          if [ "$DRY_RUN" = "true" ]; then
            echo "Mode: DRY RUN (no changes will be made)"
          fi
          echo ""

          # Calculate dates
          STALE_DATE=$(date -d "-${{ env.DAYS_BEFORE_STALE }} days" -Iseconds)
          CLOSE_DATE=$(date -d "-${{ env.DAYS_BEFORE_CLOSE }} days" -Iseconds)

          echo "Configuration:"
          echo "  - Days before stale: ${{ env.DAYS_BEFORE_STALE }}"
          echo "  - Days before close: ${{ env.DAYS_BEFORE_CLOSE }}"
          echo "  - Stale label: ${{ env.STALE_LABEL }}"
          echo "  - Stale threshold: $STALE_DATE"
          echo "  - Close threshold: $CLOSE_DATE"
          echo ""

          # Fetch all open issues (excluding PRs)
          echo "Fetching open issues..."
          ISSUES_JSON=$(gh api "repos/$FULL_REPO/issues?state=open&per_page=100" --paginate 2>/dev/null || echo "[]")
          ((API_CALLS++)) || true

          # Filter to only issues (not PRs) and count - using tab delimiter to handle pipes in titles
          ISSUES_LIST=$(echo "$ISSUES_JSON" | jq -r '.[] | select(.pull_request == null) | "\(.number)\t\(.title)\t\(.updated_at)\t\(.labels | map(.name) | join(","))"' 2>/dev/null || echo "")
          if [ -n "$ISSUES_LIST" ] && [ "$ISSUES_LIST" != "" ]; then
            ISSUES_FETCHED=$(echo "$ISSUES_LIST" | wc -l | tr -d ' ')
          else
            ISSUES_FETCHED=0
          fi

          # Fetch all open PRs
          echo "Fetching open pull requests..."
          PRS_JSON=$(gh api "repos/$FULL_REPO/pulls?state=open&per_page=100" --paginate 2>/dev/null || echo "[]")
          ((API_CALLS++)) || true

          # Using tab delimiter to handle pipes in titles
          PRS_LIST=$(echo "$PRS_JSON" | jq -r '.[] | "\(.number)\t\(.title)\t\(.updated_at)\t\(.labels | map(.name) | join(","))"' 2>/dev/null || echo "")
          if [ -n "$PRS_LIST" ] && [ "$PRS_LIST" != "" ]; then
            PRS_FETCHED=$(echo "$PRS_LIST" | wc -l | tr -d ' ')
          else
            PRS_FETCHED=0
          fi

          TOTAL_ITEMS=$((ISSUES_FETCHED + PRS_FETCHED))
          echo ""
          echo "Processing batch containing $TOTAL_ITEMS items..."
          echo ""

          # Process issues to mark as stale (using here-string to avoid subshell)
          if [ -n "$ISSUES_LIST" ] && [ "$ISSUES_LIST" != "" ]; then
            while IFS=$'\t' read -r number title updated_at labels; do
              if [ -z "$number" ]; then continue; fi
              
              # Check if already has stale label (exact match using comma boundaries)
              if echo ",$labels," | grep -qF ",${{ env.STALE_LABEL }},"; then
                # Check if should be closed
                if [[ "$updated_at" < "$CLOSE_DATE" ]]; then
                  echo "[#$number] Issue #$number - \"$title\""
                  echo "         -> Closing (stale for more than ${{ env.DAYS_BEFORE_CLOSE }} days)"
                  if [ "$DRY_RUN" != "true" ]; then
                    # No comment for issues (to avoid notifications) - only close
                    gh api -X PATCH "repos/$FULL_REPO/issues/$number" -f state="closed" -f state_reason="not_planned" 2>/dev/null || true
                    ((API_CALLS++)) || true
                    ((OPERATIONS_PERFORMED++)) || true
                  fi
                  ((ISSUES_CLOSED++)) || true
                else
                  echo "[#$number] Issue #$number - Already stale, not yet due for close"
                fi
              else
                # Check if should be marked stale
                if [[ "$updated_at" < "$STALE_DATE" ]]; then
                  echo "[#$number] Issue #$number - \"$title\""
                  echo "         -> Marking as stale (inactive for more than ${{ env.DAYS_BEFORE_STALE }} days)"
                  if [ "$DRY_RUN" != "true" ]; then
                    # No comment for issues (to avoid notifications) - only add label
                    gh api -X POST "repos/$FULL_REPO/issues/$number/labels" -f "labels[]=${{ env.STALE_LABEL }}" 2>/dev/null || true
                    ((API_CALLS++)) || true
                    ((OPERATIONS_PERFORMED++)) || true
                  fi
                  ((ISSUES_MARKED_STALE++)) || true
                fi
              fi
            done <<< "$ISSUES_LIST"
          fi

          # Process PRs to mark as stale (using here-string to avoid subshell)
          if [ -n "$PRS_LIST" ] && [ "$PRS_LIST" != "" ]; then
            while IFS=$'\t' read -r number title updated_at labels; do
              if [ -z "$number" ]; then continue; fi
              
              # Skip PRs with exempt label (exact match using comma boundaries)
              if echo ",$labels," | grep -qF ",${{ env.EXEMPT_PR_LABEL }},"; then
                echo "[#$number] Pull request #$number - Skipped (has '${{ env.EXEMPT_PR_LABEL }}' label)"
                continue
              fi
              
              # Check if already has stale label (exact match using comma boundaries)
              if echo ",$labels," | grep -qF ",${{ env.STALE_LABEL }},"; then
                # Check if should be closed
                if [[ "$updated_at" < "$CLOSE_DATE" ]]; then
                  echo "[#$number] Pull request #$number - \"$title\""
                  echo "         -> Closing (stale for more than ${{ env.DAYS_BEFORE_CLOSE }} days)"
                  if [ "$DRY_RUN" != "true" ]; then
                    gh api -X POST "repos/$FULL_REPO/issues/$number/comments" -f body="${{ env.CLOSE_PR_MESSAGE }}" 2>/dev/null || true
                    gh api -X PATCH "repos/$FULL_REPO/issues/$number" -f state="closed" 2>/dev/null || true
                    ((API_CALLS+=2)) || true
                    ((OPERATIONS_PERFORMED+=2)) || true
                  fi
                  ((PRS_CLOSED++)) || true
                else
                  echo "[#$number] Pull request #$number - Already stale, not yet due for close"
                fi
              else
                # Check if should be marked stale
                if [[ "$updated_at" < "$STALE_DATE" ]]; then
                  echo "[#$number] Pull request #$number - \"$title\""
                  echo "         -> Marking as stale (inactive for more than ${{ env.DAYS_BEFORE_STALE }} days)"
                  if [ "$DRY_RUN" != "true" ]; then
                    gh api -X POST "repos/$FULL_REPO/issues/$number/labels" -f "labels[]=${{ env.STALE_LABEL }}" 2>/dev/null || true
                    gh api -X POST "repos/$FULL_REPO/issues/$number/comments" -f body="${{ env.STALE_PR_MESSAGE }}" 2>/dev/null || true
                    ((API_CALLS+=2)) || true
                    ((OPERATIONS_PERFORMED+=2)) || true
                  fi
                  ((PRS_MARKED_STALE++)) || true
                fi
              fi
            done <<< "$PRS_LIST"
          fi

          echo ""
          echo "Batch processed."
          echo ""

          # Get API rate limit info
          RATE_INFO=$(gh api rate_limit 2>/dev/null || echo '{"rate":{"remaining":"unknown","reset":0}}')
          ((API_CALLS++)) || true
          RATE_REMAINING=$(echo "$RATE_INFO" | jq -r '.rate.remaining // "unknown"')
          RATE_RESET=$(echo "$RATE_INFO" | jq -r '.rate.reset // 0')
          if [ "$RATE_RESET" != "0" ] && [ "$RATE_RESET" != "unknown" ]; then
            RATE_RESET_DATE=$(date -d "@$RATE_RESET" 2>/dev/null || echo "unknown")
          else
            RATE_RESET_DATE="unknown"
          fi

          # Print statistics
          echo "========================================"
          echo "Statistics for $FULL_REPO:"
          echo "========================================"
          echo ""
          echo "Fetched items: $TOTAL_ITEMS"
          echo "  - Issues: $ISSUES_FETCHED"
          echo "  - PRs   : $PRS_FETCHED"
          echo ""
          echo "Actions taken:"
          echo "  - Issues marked stale: $ISSUES_MARKED_STALE"
          echo "  - PRs marked stale   : $PRS_MARKED_STALE"
          echo "  - Issues closed      : $ISSUES_CLOSED"
          echo "  - PRs closed         : $PRS_CLOSED"
          echo ""
          echo "API usage:"
          echo "  - API calls made     : $API_CALLS"
          echo "  - Rate limit remaining: $RATE_REMAINING"
          echo "  - Rate limit resets  : $RATE_RESET_DATE"
          echo ""
          if [ "$DRY_RUN" = "true" ]; then
            echo "NOTE: Dry run mode - no actual changes were made"
            echo ""
          fi
          echo "Completed processing $FULL_REPO"
          echo "========================================"

          # Save statistics to file for aggregation
          # Ensure all values are valid integers (default to 0 if empty or invalid)
          mkdir -p stats
          STATS_ISSUES_FETCHED=$((ISSUES_FETCHED + 0))
          STATS_PRS_FETCHED=$((PRS_FETCHED + 0))
          STATS_ISSUES_MARKED_STALE=$((ISSUES_MARKED_STALE + 0))
          STATS_PRS_MARKED_STALE=$((PRS_MARKED_STALE + 0))
          STATS_ISSUES_CLOSED=$((ISSUES_CLOSED + 0))
          STATS_PRS_CLOSED=$((PRS_CLOSED + 0))
          STATS_API_CALLS=$((API_CALLS + 0))
          STATS_OPERATIONS=$((OPERATIONS_PERFORMED + 0))

          echo "{\"repo\":\"$REPO\",\"issues_fetched\":$STATS_ISSUES_FETCHED,\"prs_fetched\":$STATS_PRS_FETCHED,\"issues_marked_stale\":$STATS_ISSUES_MARKED_STALE,\"prs_marked_stale\":$STATS_PRS_MARKED_STALE,\"issues_closed\":$STATS_ISSUES_CLOSED,\"prs_closed\":$STATS_PRS_CLOSED,\"api_calls\":$STATS_API_CALLS,\"operations_performed\":$STATS_OPERATIONS}" > "stats/$REPO.json"

          echo "Saved statistics to stats/$REPO.json:"
          cat "stats/$REPO.json"

      - name: Upload statistics
        uses: actions/upload-artifact@v4
        with:
          name: stats-${{ matrix.repo }}
          path: stats/${{ matrix.repo }}.json
          retention-days: 1

  summary:
    needs: [get-repositories, process-stale]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all statistics
        uses: actions/download-artifact@v4
        with:
          pattern: stats-*
          path: all-stats
          merge-multiple: true
        continue-on-error: true

      - name: Generate summary
        env:
          GH_TOKEN: ${{ secrets.GH_ORG_TOKEN }}
        run: |
          ORG="${{ inputs.org_name || 'HausAnalytics' }}"
          STALE_LABEL="${{ env.STALE_LABEL }}"

          # Determine if dry run (scheduled runs are always dry run)
          if [ "${{ github.event_name }}" = "schedule" ]; then
            IS_DRY_RUN="true (scheduled runs are dry run only)"
          else
            IS_DRY_RUN="${{ inputs.dry_run || 'false' }}"
          fi

          echo "## Organization Stale Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization:** $ORG" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** $IS_DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "- **Stale After:** ${{ env.DAYS_BEFORE_STALE }} days" >> $GITHUB_STEP_SUMMARY
          echo "- **Close After:** ${{ env.DAYS_BEFORE_CLOSE }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Aggregate statistics from all repository runs
          echo "### Actions Taken This Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_ISSUES_FETCHED=0
          TOTAL_PRS_FETCHED=0
          TOTAL_ISSUES_MARKED_STALE=0
          TOTAL_PRS_MARKED_STALE=0
          TOTAL_ISSUES_CLOSED=0
          TOTAL_PRS_CLOSED=0
          TOTAL_API_CALLS=0
          REPOS_PROCESSED=0

          # Debug: Show what was downloaded
          echo "Debug: Checking for downloaded artifacts..."
          ls -la all-stats/ 2>/dev/null || echo "all-stats directory not found"
          find all-stats -name "*.json" 2>/dev/null || echo "No JSON files found"

          # Find all JSON files recursively (handles nested directories)
          if [ -d "all-stats" ]; then
            while IFS= read -r stats_file; do
              if [ -f "$stats_file" ]; then
                echo "Processing: $stats_file"
                TOTAL_ISSUES_FETCHED=$((TOTAL_ISSUES_FETCHED + $(jq -r '.issues_fetched // 0' "$stats_file")))
                TOTAL_PRS_FETCHED=$((TOTAL_PRS_FETCHED + $(jq -r '.prs_fetched // 0' "$stats_file")))
                TOTAL_ISSUES_MARKED_STALE=$((TOTAL_ISSUES_MARKED_STALE + $(jq -r '.issues_marked_stale // 0' "$stats_file")))
                TOTAL_PRS_MARKED_STALE=$((TOTAL_PRS_MARKED_STALE + $(jq -r '.prs_marked_stale // 0' "$stats_file")))
                TOTAL_ISSUES_CLOSED=$((TOTAL_ISSUES_CLOSED + $(jq -r '.issues_closed // 0' "$stats_file")))
                TOTAL_PRS_CLOSED=$((TOTAL_PRS_CLOSED + $(jq -r '.prs_closed // 0' "$stats_file")))
                TOTAL_API_CALLS=$((TOTAL_API_CALLS + $(jq -r '.api_calls // 0' "$stats_file")))
                ((REPOS_PROCESSED++)) || true
              fi
            done < <(find all-stats -name "*.json" 2>/dev/null)
          fi

          TOTAL_FETCHED=$((TOTAL_ISSUES_FETCHED + TOTAL_PRS_FETCHED))
          TOTAL_MARKED_STALE=$((TOTAL_ISSUES_MARKED_STALE + TOTAL_PRS_MARKED_STALE))
          TOTAL_CLOSED=$((TOTAL_ISSUES_CLOSED + TOTAL_PRS_CLOSED))

          echo "| Metric | Issues | PRs | Total |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|-----|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Fetched | $TOTAL_ISSUES_FETCHED | $TOTAL_PRS_FETCHED | $TOTAL_FETCHED |" >> $GITHUB_STEP_SUMMARY
          echo "| Marked Stale | $TOTAL_ISSUES_MARKED_STALE | $TOTAL_PRS_MARKED_STALE | $TOTAL_MARKED_STALE |" >> $GITHUB_STEP_SUMMARY
          echo "| Closed | $TOTAL_ISSUES_CLOSED | $TOTAL_PRS_CLOSED | $TOTAL_CLOSED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Repositories Processed:** $REPOS_PROCESSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Total API Calls:** $TOTAL_API_CALLS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Calculate close threshold date (items not updated in last DAYS_BEFORE_CLOSE days)
          CLOSE_DATE=$(date -d "-${{ env.DAYS_BEFORE_CLOSE }} days" +%Y-%m-%d)

          # Query total stale issues and PRs across the organization
          echo "### Current Stale Items (after this run)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Search for open issues with stale label
          STALE_ISSUES=$(gh api "search/issues?q=org:$ORG+is:issue+is:open+label:$STALE_LABEL" --jq '.total_count' 2>/dev/null || echo "0")

          # Search for open PRs with stale label
          STALE_PRS=$(gh api "search/issues?q=org:$ORG+is:pr+is:open+label:$STALE_LABEL" --jq '.total_count' 2>/dev/null || echo "0")

          TOTAL_STALE=$((STALE_ISSUES + STALE_PRS))

          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Stale Issues | $STALE_ISSUES |" >> $GITHUB_STEP_SUMMARY
          echo "| Stale PRs | $STALE_PRS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL_STALE** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Query stale items about to be closed (not updated since close threshold)
          echo "### Items About to Close (stalled ${{ env.DAYS_BEFORE_CLOSE }}+ days after ${{ env.DAYS_BEFORE_STALE }}-day stale window)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Search for stale issues about to close
          CLOSING_ISSUES=$(gh api "search/issues?q=org:$ORG+is:issue+is:open+label:$STALE_LABEL+updated:<$CLOSE_DATE" --jq '.total_count' 2>/dev/null || echo "0")

          # Search for stale PRs about to close
          CLOSING_PRS=$(gh api "search/issues?q=org:$ORG+is:pr+is:open+label:$STALE_LABEL+updated:<$CLOSE_DATE" --jq '.total_count' 2>/dev/null || echo "0")

          TOTAL_CLOSING=$((CLOSING_ISSUES + CLOSING_PRS))

          echo "| Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Issues closing soon | $CLOSING_ISSUES |" >> $GITHUB_STEP_SUMMARY
          echo "| PRs closing soon | $CLOSING_PRS |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL_CLOSING** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Stale Label: \`$STALE_LABEL\`" >> $GITHUB_STEP_SUMMARY
          echo "- Exempt PR Label: \`${{ env.EXEMPT_PR_LABEL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Get Repositories: ${{ needs.get-repositories.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Process Stale: ${{ needs.process-stale.result }}" >> $GITHUB_STEP_SUMMARY
